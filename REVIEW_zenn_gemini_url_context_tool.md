# articles/zenn_gemini_url_context_tool.mdã®è¨˜äº‹ãƒ¬ãƒ“ãƒ¥ãƒ¼

## ğŸš© ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡
è¦ªè¨˜äº‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å†…å®¹ã‚’å¼•ãç¶™ã„ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®3ã¤ã®è¦³ç‚¹ã‹ã‚‰ã€Œå†…å®¹ã‚’æ­£ã—ãç†è§£ã§ãã‚‹ã‹ã€ã‚’è»¸ã«ç¢ºèªã—ã€æ°—ä»˜ã„ãŸç‚¹ã‚’æŒ‡æ‘˜ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚

---

## ãƒã‚§ãƒƒã‚¯çµæœã¨è¦³ç‚¹

| è¦³ç‚¹ | æ‹…å½“è€… | ãƒã‚§ãƒƒã‚¯é …ç›® | çŠ¶æ³ |
| ---- | ------ | ------------ | ---- |
| **æ—¥æœ¬èªè¡¨ç¾** | @copilot | - èªå°¾ãƒ»èªèª¿ã®çµ±ä¸€<br>- å†—é•·ï¼é‡è¤‡è¡¨ç¾ã®å‰Šé™¤<br>- å¥èª­ç‚¹ãƒ»æ”¹è¡Œä½ç½® | - [x] æ¸ˆ |
| **å†…å®¹ç†è§£ï¼ˆWebã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢è¦–ç‚¹ï¼‰** | @copilot | - æ‰‹é †ã©ãŠã‚Šã«å†ç¾ã§ãã‚‹ã‹<br>- IDE é€£æºä¾‹ãŒå®Ÿå‹•ã‹<br>- ã‚³ãƒãƒ³ãƒ‰èª¤è¨˜ã®æœ‰ç„¡ | - [x] æ¸ˆ |
| **å†…å®¹ç†è§£ï¼ˆAIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢è¦–ç‚¹ï¼‰** | @copilot | - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ã®å¦¥å½“æ€§<br>- ãƒ¡ãƒ¢ãƒªï¼MCP è¨­å®šã®é©åˆ‡ã•<br>- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆéµç®¡ç†ï¼‰ã®éä¸è¶³ | - [x] æ¸ˆ |

### å…±é€šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [x] è¦‹å‡ºã—éšå±¤ãŒæ­£ã—ã„  
- [x] è¡¨ã«é•·æ–‡ãŒå…¥ã£ã¦ã„ãªã„  
- [x] ç”»åƒãƒ‘ã‚¹ãŒ Zenn Preview ã§è§£æ±ºã™ã‚‹ï¼ˆç”»åƒãªã—ï¼‰  
- [x] å…¬å¼ãƒªãƒ³ã‚¯ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼ˆMarkdown linkï¼‰  
- [x] å‰å¾Œç·¨ãƒªãƒ³ã‚¯ãŒæ©Ÿèƒ½ã™ã‚‹ï¼ˆå˜ä½“è¨˜äº‹ï¼‰  

---

## æŒ‡æ‘˜ã‚³ãƒ¡ãƒ³ãƒˆ

### è©²å½“ç®‡æ‰€ 1
L50-L52 ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼‰

```
prompt = """æ¬¡ã®URLã‚’URL context toolã§å‚ç…§ã—ã€æœ¬æ–‡ã«å¿ å®Ÿã«3ç‚¹ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚
URL: https://nextjs.org/docs/app
"""
```

### å•é¡Œç‚¹
ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§ã€Œ3ç‚¹ã§è¦ç´„ã€ã¨æŒ‡å®šã—ã¦ã„ã‚‹ãŒã€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆL83-L85ï¼‰ã§æœŸå¾…ã•ã‚Œã‚‹å†…å®¹ã¨ã—ã¦å…·ä½“ä¾‹ãŒç¤ºã•ã‚Œã¦ã„ã‚‹ã€‚ä¸€è²«æ€§ã®ã‚ã‚‹æŒ‡ç¤ºã«ãªã£ã¦ã„ãªã„ã€‚

### ææ¡ˆ
```python
prompt = """æ¬¡ã®URLã‚’URL context toolã§å‚ç…§ã—ã€ä»¥ä¸‹ã®è¦³ç‚¹ã§è¦ç´„ã—ã¦ãã ã•ã„ï¼š
1. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ä»•çµ„ã¿
2. æ–°æ©Ÿèƒ½ãƒ»ç‰¹å¾´
3. å¾“æ¥ç‰ˆã¨ã®é•ã„

URL: https://nextjs.org/docs/app
"""
```

---

### è©²å½“ç®‡æ‰€ 2
L144-L153 ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé››å½¢ï¼‰

```
ã‚ãªãŸã¯æŠ€è¡“ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®URLã‚’URL context toolã§å‚ç…§ã—ã€å…¬å¼æœ¬æ–‡ã«å¿ å®Ÿã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚

å‡ºåŠ›è¦ä»¶:
- ç®‡æ¡æ›¸ãã§5ç‚¹
- å¼•ç”¨ã¯10èªä»¥å†…
- JSONã‚‚å‡ºåŠ›ï¼ˆkeys: title, key_points[], citations[]ï¼‰ã€‚citationsã¯å‚ç…§URLã®é…åˆ—ã€‚

å¯¾è±¡URL:
{{URL}}
```

### å•é¡Œç‚¹
ã€Œå¼•ç”¨ã¯10èªä»¥å†…ã€ã¨ã„ã†åˆ¶ç´„ãŒæ›–æ˜§ã€‚æ—¥æœ¬èªã®èªæ•°ã‚«ã‚¦ãƒ³ãƒˆã¯å˜èªã®åŒºåˆ‡ã‚ŠãŒæ˜ç¢ºã§ãªã„ãŸã‚ã€å®Ÿè¡Œæ™‚ã«æ··ä¹±ã‚’æ‹›ãå¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

### ææ¡ˆ
```text
- å¼•ç”¨ã¯30æ–‡å­—ä»¥å†…
```
ã¾ãŸã¯
```text  
- å¼•ç”¨ã¯ç°¡æ½”ã«ï¼ˆé‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã¿ï¼‰
```

---

### è©²å½“ç®‡æ‰€ 3
L177-L190 ï¼ˆcontent_hashé–¢æ•°ï¼‰

```python
def content_hash(url: str) -> str:
    """è»½é‡ãªæ›´æ–°æ¤œçŸ¥ï¼ˆETag/Last-Modifiedâ†’fallbackã§bodyå…ˆé ­ï¼‰"""
    try:
        r = requests.head(url, timeout=10, allow_redirects=True)
        tag = r.headers.get("ETag") or r.headers.get("Last-Modified")
        if tag:
            return hashlib.sha256(tag.encode()).hexdigest()
    except Exception:
        pass
    try:
        r = requests.get(url, timeout=15)
        r.raise_for_status()
        return hashlib.sha256(r.content[:100_000]).hexdigest()
    except Exception:
        return str(time.time())  # å¤±æ•—æ™‚ã¯æ¯å›å®Ÿè¡Œã«å€’ã™
```

### å•é¡Œç‚¹
ä¾‹å¤–å‡¦ç†ã§ã¾ã¨ã‚ã¦`pass`ã¨`Exception`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¨HTTPã‚¨ãƒ©ãƒ¼ãŒåŒºåˆ¥ã§ããªã„ã€‚ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

### ææ¡ˆ
```python
def content_hash(url: str) -> str:
    """è»½é‡ãªæ›´æ–°æ¤œçŸ¥ï¼ˆETag/Last-Modifiedâ†’fallbackã§bodyå…ˆé ­ï¼‰"""
    try:
        r = requests.head(url, timeout=10, allow_redirects=True)
        tag = r.headers.get("ETag") or r.headers.get("Last-Modified")
        if tag:
            return hashlib.sha256(tag.encode()).hexdigest()
    except (requests.RequestException, Exception) as e:
        print(f"HEAD request failed for {url}: {e}")
    
    try:
        r = requests.get(url, timeout=15)
        r.raise_for_status()
        return hashlib.sha256(r.content[:100_000]).hexdigest()
    except requests.RequestException as e:
        print(f"GET request failed for {url}: {e}")
        return str(time.time())  # å¤±æ•—æ™‚ã¯æ¯å›å®Ÿè¡Œã«å€’ã™
```

---

### è©²å½“ç®‡æ‰€ 4
L134-L138 ï¼ˆç’°å¢ƒå¤‰æ•°ä¾‹ï¼‰

```env
GOOGLE_GENAI_API_KEY=xxxxx
NOTION_TOKEN=xxxxx
NOTION_DATABASE_ID=xxxxx
SLACK_BOT_TOKEN=xoxb-xxxxx
SLACK_CHANNEL_ID=Cxxxxx
```

### å•é¡Œç‚¹
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šé‡è¦ãªç’°å¢ƒå¤‰æ•°ã®ä¾‹ãŒå…·ä½“çš„éãã‚‹ã€‚ç‰¹ã« `SLACK_BOT_TOKEN=xoxb-xxxxx` ã¯å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼ã‚’ç¤ºã—ã¦ãŠã‚Šã€èª¤è§£ã‚’æ‹›ãå¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

### ææ¡ˆ
```env
GOOGLE_GENAI_API_KEY=your_gemini_api_key_here
NOTION_TOKEN=your_notion_integration_token
NOTION_DATABASE_ID=your_database_id
SLACK_BOT_TOKEN=your_slack_bot_token
SLACK_CHANNEL_ID=your_channel_id
```

---

### è©²å½“ç®‡æ‰€ 5
L267-L270 ï¼ˆè¤‡æ•°URLä¾‹ï¼‰

```text
å¯¾è±¡URL:
- https://nextjs.org/docs/app
- https://nextjs.org/docs/app/building-your-application/routing
- https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts
```

### å•é¡Œç‚¹
å®Ÿéš›ã®å‹•ä½œç¢ºèªãŒã§ããªã„URLä¾‹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚è¨˜äº‹ã®ä¿¡é ¼æ€§å‘ä¸Šã®ãŸã‚ã€åŸ·ç­†æ™‚ç‚¹ã§ã®æœ‰åŠ¹ãªURLã‚’ä½¿ç”¨ã™ã¹ãã€‚

### ææ¡ˆ
URLã®æœ‰åŠ¹æ€§ã‚’ç¢ºèªã™ã‚‹ã‹ã€ã‚ˆã‚Šæ±ç”¨çš„ãªä¾‹ã‚’ä½¿ç”¨ï¼š
```text
å¯¾è±¡URL:
- https://example.com/docs/main
- https://example.com/docs/section1  
- https://example.com/docs/section2
```

---

### è©²å½“ç®‡æ‰€ 6
L396-L404 ï¼ˆãƒªãƒˆãƒ©ã‚¤å‡¦ç†ï¼‰

```python
def retry(func, max_attempts=3):
    for i in range(max_attempts):
        try:
            return func()
        except Exception:
            time.sleep(2 ** i)
    raise
```

### å•é¡Œç‚¹
æœ€å¾Œã®`raise`ã§å…ƒã®ä¾‹å¤–æƒ…å ±ãŒå¤±ã‚ã‚Œã‚‹ã€‚ã©ã®è©¦è¡Œã§ä½•ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‹ãƒˆãƒ¬ãƒ¼ã‚¹ã§ããªã„ã€‚

### ææ¡ˆ
```python
def retry(func, max_attempts=3):
    last_exception = None
    for i in range(max_attempts):
        try:
            return func()
        except Exception as e:
            last_exception = e
            if i < max_attempts - 1:  # æœ€å¾Œã®è©¦è¡Œã§ãªã„å ´åˆã®ã¿sleep
                time.sleep(2 ** i)
    raise last_exception
```

---

### è©²å½“ç®‡æ‰€ 7
L415-L419 ï¼ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰

```
- [ ] APIã‚­ãƒ¼ãƒ»Secretã¯ GitHub Secrets / 1Password ã§ä¸€å…ƒç®¡ç†  
- [ ] å‚ç…§URLã¯ **å…¬é–‹ãƒšãƒ¼ã‚¸ã®ã¿**ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«ä¸å¯ï¼‰  
- [ ] `url_context_metadata` ã‚’ **æ¯å›ä¿å­˜**ï¼ˆæ¤œè¨¼ï¼†ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œï¼‰  
- [ ] å¤±æ•—URLã¯ **å†è©¦è¡Œã‚­ãƒ¥ãƒ¼** ã§åˆ¥ç®¡ç†  
- [ ] é€±æ¬¡ã§ **ä¸è¦URLã®æ£šå¸ã—**ï¼**ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®æ£šå¸ã—**
```

### å•é¡Œç‚¹
ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒæœªãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ï¼ˆ`- [ ]`ï¼‰ã®ã¾ã¾ã ãŒã€ã“ã‚Œã¯èª­è€…ãŒå®Ÿéš›ã«ä½¿ç”¨ã™ã‚‹éš›ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¨ã—ã¦æç¤ºã™ã¹ãã€‚

### ææ¡ˆ
è¨˜äº‹å†…ã§ã¯èª¬æ˜ã¨ã—ã¦æ‰±ã„ã€å®Ÿéš›ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æä¾›ã™ã‚‹ã“ã¨ã‚’æ˜è¨˜ï¼š
```markdown
## 9. é‹ç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰

é‹ç”¨é–‹å§‹æ™‚ã«ã¯ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š

- [ ] APIã‚­ãƒ¼ãƒ»Secretã¯ GitHub Secrets / 1Password ã§ä¸€å…ƒç®¡ç†  
- [ ] å‚ç…§URLã¯ **å…¬é–‹ãƒšãƒ¼ã‚¸ã®ã¿**ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«ä¸å¯ï¼‰  
- [ ] `url_context_metadata` ã‚’ **æ¯å›ä¿å­˜**ï¼ˆæ¤œè¨¼ï¼†ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œï¼‰  
- [ ] å¤±æ•—URLã¯ **å†è©¦è¡Œã‚­ãƒ¥ãƒ¼** ã§åˆ¥ç®¡ç†  
- [ ] é€±æ¬¡ã§ **ä¸è¦URLã®æ£šå¸ã—**ï¼**ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®æ£šå¸ã—**
```

---

## ç·åˆè©•ä¾¡

### è‰¯ã„ç‚¹
- å®Ÿå‹™ã§ã®å°å…¥ã‚’æ„è­˜ã—ãŸæ®µéšçš„ãªæ§‹æˆ
- ã‚³ãƒ¼ãƒ‰ä¾‹ãŒè±Šå¯Œã§å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã—ã‚„ã™ã„
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚„é‹ç”¨é¢ã®è€ƒæ…®ãŒå«ã¾ã‚Œã¦ã„ã‚‹
- mermaidå›³è¡¨ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè¦–è¦šçš„ã«ç†è§£ã—ã‚„ã™ã„

### æ”¹å–„ç‚¹
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ã®ä¸€è²«æ€§å‘ä¸Š
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è©³ç´°åŒ–
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¾‹ç¤ºã®é©åˆ‡åŒ–
- URLä¾‹ã®æœ‰åŠ¹æ€§ç¢ºèª

### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. æŒ‡æ‘˜ç®‡æ‰€ã®ä¿®æ­£
2. ã‚³ãƒ¼ãƒ‰ä¾‹ã®å‹•ä½œç¢ºèª
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£è¨˜è¿°ã®è¦‹ç›´ã—
4. èª­è€…ãŒãã®ã¾ã¾ä½¿ãˆã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æä¾›

---

*ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½è€…: @copilot*  
*ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½æ—¥: 2025-08-23*